<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

	<head>
	
		<meta charset="UTF-8">
		<title>Departments Table</title>
		
		<!-- Icon Font Stylesheet -->
	    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
	    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
	
	    <!-- Libraries Stylesheet -->
	    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
	    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />
	
	    <!-- Customized Bootstrap Stylesheet -->
	    <link href="css/bootstrap.min.css" rel="stylesheet">
	
	    <!-- Template Stylesheet -->
	    <link href="css/style.css" rel="stylesheet">
		
		
		<style>
			.modalAdd
			{
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height:100%;
				display:none;
				justify-content: center;
				align-items: center;
				background: rgba(0,0,0,0.5);
				z-index: 1000;
			}		
			
			.modalContent
			{
				background: #fff;
				padding: 20px 30px;
				border-radius: 10px;
				min-width: 300px;
				box-shadow: 0 4px 10px rgba(0,0,0,0.3);
			}
		</style>
		
		
	</head>

	
	<body>
		<th:block th:insert="~{fragments_sidebar::sidebar}"></th:block>
		<div class="content">
			<div class="bg-secondary rounded h-100 p-4">
				<h3 class="mb-4">departments Table INFO</h3>
				<div class="bg-secondary rounded h-100 p-4">
					<table class="table">
						<thead>				
							<tr>
								<th scope = "col">No</th>
								<th scope = "col">dept_no</th>
								<th scope = "col">dept_name</th>
							</tr>
						</thead>	
						
						<tbody>
							<tr th:each="department, stat : ${departments}">
								<td scope = "row" th:text = "${stat.count}"></td>
								<td scope = "row" th:text = "${department.dept_no}"></td>
								<td scope = "row" th:text = "${department.dept_name}"></td>
							</tr>
						</tbody>
					</table>	
				</div>
				
				<button id = "addDepartment" class = "btn btn-success m-2">부서 추가</button>
				<p></p>

				<div style = color:red;>
					<h5 style = color:yellow;>
						[부서 추가 시 중요 사항]
					</h5>
					기존에 있던 부서의 이름과 번호는<br>
					중복 될 수 없습니다!!
				</div>
				
			</div>

			
			<div id= "modalAdd" class = "modalAdd">
				<div class = "modalContent">
					<label>부서 - ID : <input type="text" id ="dept_no"   required="required"></label><br>
					<label>부서 이름 : <input type="text" id ="dept_name" required="required"></label><br>
					
				
					<button id = "submitBtn" class = "btn btn-success m-2">확인</button><br>
				</div>
			</div>
			<!--  이 스코프에 작성 -->
		</div>
		
		
		
		
		<script>
			const addBtn = document.getElementById("addDepartment");
			const submintBtn = document.getElementById("submitBtn");
			const modal = document.getElementById("modalAdd");
			
			addBtn.onclick = function() {
				modal.style.display = "flex";
			}
			
			
			submintBtn.onclick = function (event)
			{
				modal.style.display = "none";
				addDepartment(event);
			}
			
			
			function addDepartment(event)
			{
				event.preventDefault();
				
				let dept_no = document.getElementById("dept_no").value;
				let dept_name = document.getElementById("dept_name").value;
				
				// 1. XMLHttpRequest 객체 생성
				var xhr = new XMLHttpRequest();
				
				// 2. 이벤트 핸들러 등록
				xhr.onreadystatechange = function ()
				{
					if (xhr.readyState === 4 && xhr.status === 200)
					{
						var requestResult = Number(xhr.response);
						
						console.log("Ajax 통신 상태(readyState)는 1, 2, 3, 4 별로 의미가 있음 (구글링 해보셈!)")
						console.log("현재 Ajax 통신 상태 : " + xhr.readyState);
						console.log("백엔드 요청으로 반환된 숫자 값 : " + requestResult);
						
						if (!requestResult)
						{
							alert("삽입에 실패했습니다!\n" + "사용자가 중복된 부서번호 또는 부서 이름을 입력했습니다...");
							return;
						}
						
						var departmentsTable = document.querySelector('table');

						// insertRow(0) 처음에 추가, insertRow(3) 이 위치에 추가, -1 맨 뒤에 추가
						var row = departmentsTable.insertRow(-1);	
						
						const lastNo = departmentsTable.rows.length;
						
						var cellNo = row.insertCell(0);
						var cellDept_no = row.insertCell(1);
						var cellDept_name = row.insertCell(2);
						
						cellNo.innerHTML = lastNo - 1;
						cellDept_no.innerHTML = dept_no;
						cellDept_name.innerHTML = dept_name;
						
						alert("삽입에 성공했습니다!\n" + requestResult + "개의 행이 업데이트 되었습니다.");
					}
				}
				
				// 3. http 요청 초기화
				xhr.open('POST', '/ajaxInsertDepartment', true);
				
				// 4. http 요청 헤더 설정
				xhr.setRequestHeader('Content-Type', 'application/json');
				
				// 5. http 요청 전송
	            xhr.send(JSON.stringify({dept_no:dept_no, dept_name:dept_name}));
			}
			
			
		</script>
		
		
	</body>
</html>